<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPS Ultra - Final</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-medium: #16213e;
            --bg-light: #0f3460;
            --primary-accent: #e94560;
            --secondary-accent: #53bf9d; /* Green for Win */
            --loss-color: #e74c3c;      /* Red for Lose */
            --text-color: #dcdcdc;
            --font-main: 'Poppins', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        header h1 {
            font-size: 2.5rem;
            color: var(--primary-accent);
            text-shadow: 0 0 10px var(--primary-accent);
        }

        .match-area {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            gap: 20px;
        }

        .player-card {
            background: var(--bg-medium);
            border-radius: 20px;
            padding: 20px;
            width: 280px;
            text-align: center;
            border: 2px solid var(--bg-light);
            transition: all 0.3s ease;
        }
        
        .player-card.winner {
            box-shadow: 0 0 25px var(--secondary-accent);
            border-color: var(--secondary-accent);
        }

        .player-card h2 { font-size: 1.5rem; margin-bottom: 15px; }
        .move-display {
            width: 120px; height: 120px;
            background: var(--bg-dark);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            margin: 15px auto;
            font-size: 4rem;
        }

        .score { font-size: 2rem; font-weight: 600; }

        .video-container {
            position: relative;
            width: 480px;
            height: 360px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #video {
            width: 100%; height: 100%;
            transform: scaleX(-1);
            object-fit: cover;
        }

        .controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            min-height: 150px;
        }
        #countdown { font-size: 5rem; font-weight: 700; color: var(--primary-accent); height: 80px; line-height: 80px; }
        #countdown.animate { animation: countdown-pulse 1s ease-in-out; }

        #start-button, #play-again-button {
            font-size: 1.5rem; padding: 15px 50px; cursor: pointer;
            border-radius: 50px; border: none;
            color: white; font-weight: 600;
            transition: all 0.2s ease;
        }
        #start-button { background-color: var(--primary-accent); }
        #start-button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4); }
        
        .game-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center; align-items: center;
        }
        .game-overlay.visible {
            display: flex;
        }
        .result-card {
            background: var(--bg-medium);
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .result-card h1 { font-size: 3rem; font-weight: 700; }
        .result-card.win h1 { color: var(--secondary-accent); }
        .result-card.lose h1 { color: var(--loss-color); }
        .result-card.win { border-color: var(--secondary-accent); }
        .result-card.lose { border-color: var(--loss-color); }

        .final-score { font-size: 1.5rem; margin: 10px 0 30px 0; color: var(--text-color); }
        #play-again-button { background-color: var(--secondary-accent); }
        #play-again-button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(83, 191, 157, 0.4); }

        @keyframes countdown-pulse { 0% { transform: scale(0.8); opacity: 0; } 50% { opacity: 1; } 100% { transform: scale(1.2); opacity: 0; } }
        
        @media (max-width: 900px) {
            .match-area { flex-direction: column; }
            .video-container { order: -1; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <div class="game-container">
        <header><h1>RPS Ultra</h1></header>
        <div class="match-area">
            <div class="player-card" id="ai-card"><h2>YOLΛ AI</h2><div class="move-display" id="ai-move">?</div><p>Score: <span class="score" id="ai-score">0</span></p></div>
            <div class="video-container"><video id="video" autoplay playsinline></video></div>
            <div class="player-card" id="player-card"><h2>{{ username }}</h2><div class="move-display" id="player-move">?</div><p>Score: <span class="score" id="player-score">0</span></p></div>
        </div>
        <div class="controls">
            <div id="countdown">Press Start</div>
            <button id="start-button">Start Game</button>
        </div>
    </div>
    <canvas id="capture-canvas" style="display:none;"></canvas>

    <div class="game-overlay" id="game-over-screen">
        <div class="result-card" id="result-card">
            <h1 id="result-title"></h1>
            <p class="final-score" id="final-score"></p>
            <button id="play-again-button">Play Again</button>
        </div>
    </div>

    <script>
        const username = "{{ username|escapejs }}";

        // --- Element References ---
        const video = document.getElementById('video');
        const startButton = document.getElementById('start-button');
        const playAgainButton = document.getElementById('play-again-button');
        const gameOverScreen = document.getElementById('game-over-screen');
        const playerScoreEl = document.getElementById('player-score');
        const aiScoreEl = document.getElementById('ai-score');
        const playerMoveEl = document.getElementById('player-move');
        const aiMoveEl = document.getElementById('ai-move');
        const countdownEl = document.getElementById('countdown');
        const captureCanvas = document.getElementById('capture-canvas');
        const captureCtx = captureCanvas.getContext('2d');

        // --- Game State ---
        const moveEmojis = { rock: '✊', paper: '✋', scissors: '✌️' };
        let playerScore = 0;
        let aiScore = 0;
        let gameLoopInterval = null;
        const winningScore = 3;

        // --- Camera Setup ---
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    captureCanvas.width = video.videoWidth;
                    captureCanvas.height = video.videoHeight;
                });
            })
            .catch(err => {
                console.error("Error accessing webcam: ", err);
                countdownEl.innerText = "Error: Webcam needed!";
            });

        // --- Game Logic ---
        function sendFrameToServer() {
            if (video.readyState < 2) return;
            
            captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
            const imageData = captureCanvas.toDataURL('image/jpeg', 0.5);

            fetch("{% url 'analyze_frame' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.winner) {
                    updateGameUI(data);
                }
            })
            .catch(error => console.error('Error analyzing frame:', error));
        }

        function updateGameUI(data) {
            playerMoveEl.innerText = moveEmojis[data.player_move] || '?';
            aiMoveEl.innerText = moveEmojis[data.ai_move] || '?';

            if (data.winner === 'player') {
                playerScore++;
            } else if (data.winner === 'ai') {
                aiScore++;
            }

            playerScoreEl.innerText = playerScore;
            aiScoreEl.innerText = aiScore;

            if (playerScore >= winningScore || aiScore >= winningScore) {
                clearInterval(gameLoopInterval);
                showGameOver();
            }
        }
        
        function runGameRound() {
            let count = 3;
            countdownEl.innerText = count;
            countdownEl.classList.add('animate');

            const timer = setInterval(() => {
                countdownEl.classList.remove('animate');
                void countdownEl.offsetWidth;
                countdownEl.classList.add('animate');
                count--;
                if (count > 0) {
                    countdownEl.innerText = count;
                } else {
                    countdownEl.innerText = "SHOOT!";
                    clearInterval(timer);
                    sendFrameToServer();
                }
            }, 1000);
        }

        function startGame() {
            startButton.style.display = 'none';
            gameOverScreen.classList.remove('visible');
            resetGame();
            runGameRound();
            gameLoopInterval = setInterval(runGameRound, 4000);
        }

        function resetGame() {
            playerScore = 0;
            aiScore = 0;
            playerScoreEl.innerText = '0';
            aiScoreEl.innerText = '0';
            playerMoveEl.innerText = '?';
            aiMoveEl.innerText = '?';
            countdownEl.innerText = '';
        }

        function showGameOver() {
            const resultCard = document.getElementById('result-card');
            const resultTitle = document.getElementById('result-title');
            const finalScoreEl = document.getElementById('final-score');

            resultCard.className = 'result-card';
            
            if (playerScore > aiScore) {
                resultTitle.innerText = `${username} Wins!`;
                resultCard.classList.add('win');
            } else {
                resultTitle.innerText = `${username} Lost!`;
                resultCard.classList.add('lose');
            }

            finalScoreEl.innerText = `Final Score: ${playerScore} - ${aiScore}`;
            gameOverScreen.classList.add('visible');
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startGame);
        
        // CHANGE: "Play Again" now redirects to the home page to enter a new name.
        playAgainButton.addEventListener('click', () => {
            window.location.href = "{% url 'home' %}";
        });

    </script>
</body>
</html>
